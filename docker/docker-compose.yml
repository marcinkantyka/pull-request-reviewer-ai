services:
  ollama:
    # Using specific version instead of 'latest' for reproducibility
    # Update this when needed: https://hub.docker.com/r/ollama/ollama/tags
    image: ollama/ollama:0.4.0
    container_name: pr-review-ollama
    volumes:
      - ollama-data:/root/.ollama
    ports:
      - '11434:11434'
    environment:
      - OLLAMA_HOST=0.0.0.0
    networks:
      - pr-review-network
    command: serve
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:11434/api/tags']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  pr-review:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    # Image version is set from PR_REVIEW_VERSION environment variable
    # Automatically reads from package.json via start.sh script
    image: pr-reviewer-pr-review:${PR_REVIEW_VERSION:-1.0.0}
    # This service is built but not started by default
    # Use run-review.sh script or docker run to execute commands
    profiles:
      - manual
    volumes:
      - ${REPO_PATH:?Set REPO_PATH to the target git repo}:/workspace:ro
      - ./output:/output
    environment:
      - LLM_PROVIDER=ollama
      - LLM_ENDPOINT=http://ollama:11434
      - LLM_MODEL=deepseek-coder:6.7b
      - NETWORK_ALLOWED_HOSTS=ollama,localhost,127.0.0.1,::1
      - NETWORK_STRICT_MODE=true
    working_dir: /workspace

networks:
  pr-review-network:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  ollama-data:
    driver: local
