services:
  ollama:
    image: ollama/ollama:latest
    container_name: pr-review-ollama
    volumes:
      - ollama-data:/root/.ollama
    ports:
      - '11434:11434'
    environment:
      - OLLAMA_HOST=0.0.0.0
    networks:
      - pr-review-network
    command: ollama serve
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  pr-review:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: pr-review-cli
    depends_on:
      - ollama
    volumes:
      - ./repos:/repos:ro # Mount repos as read-only
      - ./config:/config:ro # Mount config
      - ./output:/output # Output directory
    environment:
      - LLM_ENDPOINT=http://ollama:11434
      - LLM_MODEL=deepseek-coder:6.7b
      - CONFIG_PATH=/config/config.yml
      - NETWORK_STRICT_MODE=true
    networks:
      - pr-review-network
    dns: []
    cap_drop:
      - NET_RAW
      - NET_ADMIN
    command: >
      compare feature/new-feature main
      --repo-path /repos/my-project
      --format json
      --output /output/review.json

networks:
  pr-review-network:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  ollama-data:
    driver: local
